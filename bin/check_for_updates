#!/usr/bin/env python3

from pathlib import Path
from socket import timeout
from urllib import request
from xml.etree import ElementTree

import rospkg
import rospy
from packaging import version

GITHUB_PACKAGE_URL = "https://raw.githubusercontent.com/FieldRobotEvent/virtual_maize_field/main/package.xml"


def version_from_xml(xml_data):
    root = ElementTree.fromstring(xml_data)
    return version.parse(root.findtext("version"))


if __name__ == "__main__":
    rospy.init_node("virtual_maize_field_update_checker")

    try:
        # Get the remote version
        remote_version_xml_data = request.urlopen(GITHUB_PACKAGE_URL, timeout=2).read()
        remote_version = version_from_xml(remote_version_xml_data)

        # Get the local version
        local_package_xml = rospkg.RosPack().get_path("virtual_maize_field")
        local_package_xml_data = (Path(local_package_xml) / "package.xml").read_text(
            encoding="utf-8"
        )
        local_version = version_from_xml(local_package_xml_data)

        # Print error if we have an old local version
        if local_version < remote_version:
            rospy.logwarn(
                f"Your 'virtual_maize_field' package is outdated ({local_version} < {remote_version})! Run 'git submodule update --remote --merge' to update the package and generate new worlds."
            )

    except timeout:
        rospy.logdebug(
            "Could not get remote version of the 'virtual_maize_field' package. Probably because there is no internet available."
        )

    except Exception:
        rospy.loginfo("Could not check version of 'virtual_maize_field' package.")
